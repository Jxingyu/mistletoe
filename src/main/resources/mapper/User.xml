<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cn.mistletoe.mapper.UserMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.cn.mistletoe.model.User">
        <id column="id" property="id" />
        <result column="username" property="username" />
        <result column="password" property="password" />
        <result column="icon" property="icon" />
        <result column="email" property="email" />
        <result column="contend" property="contend" />
        <result column="create_time" property="createTime" />
        <result column="login_time" property="loginTime" />
        <result column="status" property="status" />
        <result column="captcha" property="captcha" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, username, password, icon, email, contend, create_time, login_time, status, captcha
    </sql>

<!--    <select id="checkUser" resultMap="BaseResultMap" parameterType="com.cn.mistletoe.model.User">-->
<!--&lt;!&ndash; select * from mistletoe.user where username=#{username} and password =#{password}&ndash;&gt;-->
<!-- select * from mistletoe.user where username=#{username} and password =#{password}-->
<!--    </select>-->

    <select id="getUserByUsername" resultMap="BaseResultMap"  parameterType="com.cn.mistletoe.model.User">
         select * from mistletoe.user where username=#{username};
    </select>

    <select id="getPermissionByRoleId" parameterType="java.lang.Integer" resultType="com.cn.mistletoe.model.Permission">
        select * from  mistletoe.permission p where p.id in(
            select rp.permission_id from role_permission_relation rp where rp.role_id  in
                (select ur.role_id from  user_role_relation ur where ur.user_id =#{userId})
            UNION
            select up.permission_id  from user_permission_relation up where up.type=1 and up.user_id=#{userId}
        )
        and p.id not in(
            select up.permission_id  from user_permission_relation up where up.type=-1 and up.user_id=#{userId}
        )
    </select>

    <select id="getUserById" resultMap="BaseResultMap" parameterType="com.cn.mistletoe.model.User">
        select * from user where id =#{id};
    </select>

    <select id="findAll" resultMap="BaseResultMap" parameterType="com.cn.mistletoe.model.User">
        select * from user where 1 = 1
    </select>
</mapper>
